<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ô‡∏¥‡∏™‡∏¥‡∏ï - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #000; color: white; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; border: 2px solid #0d6efd; }
        .result-box { margin-top: 20px; display: none; }
    </style>
</head>
<body>
    <div class="container text-center">
        <h4 class="mb-3">üì∏ ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
        
        <div id="reader"></div>
        
        <div id="status" class="mt-3 text-warning">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div>

        <div id="successBox" class="result-box alert alert-success">
            <h3>‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
            <p id="studentNameDisplay"></p>
            <button onclick="liff.closeWindow()" class="btn btn-success w-100">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        let lineUserId = "";

        async function main() {
            // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏° LIFF ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤ User ID ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô
            await liff.init({ liffId: "2008562649-LEXWJgaD" }); // ‡πÉ‡∏ä‡πâ ID ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            const profile = await liff.getProfile();
            lineUserId = profile.userId;
            
            // 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
            startScanner();
        }
        main();

        function startScanner() {
            const html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            document.getElementById('status').innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á...";

            // ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (facingMode: environment)
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
        }

        async function onScanSuccess(decodedText, decodedResult) {
            // decodedText ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤ QR Token ‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πà‡∏ô CLASS_1_163xxxx)
            
            // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥‡∏£‡∏±‡∏ß‡πÜ
            document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            
            try {
                // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏µ‡πà Server
                const res = await fetch('/api/check-in', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lineUserId: lineUserId,
                        qrToken: decodedText
                    })
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('reader').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á
                    document.getElementById('status').style.display = 'none';
                    document.getElementById('successBox').style.display = 'block';
                    document.getElementById('studentNameDisplay').innerText = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ " + data.studentName;
                } else {
                    alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + data.message);
                }
            } catch (err) {
                alert("Server Error: " + err);
            }
        }
    </script>
</body>
</html>